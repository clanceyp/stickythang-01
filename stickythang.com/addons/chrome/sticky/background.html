<!DOCTYPE html>
<!-- 
Copyright (c) 2011, P Clancey. All rights reserved.
Code licensed under the BSD License:
http://www.opensource.org/licenses/bsd-license.php
version: alpha 0.1
-->
<html>
  <head>
  	<script src="lib/yui/3.4.0/build/yui/yui-min.js" type="text/javascript"></script>
	
	<script type="text/javascript">
      // Called when the url of a tab changes.
      function checkForValidUrl(tabId, changeInfo, tab) {
        // If the letter 'g' is found in the tab's URL...
        if ( tab.url.indexOf('chrome://') == 0 ) {
          // don't show on chome pages
        } else {
          chrome.pageAction.show(tabId);
		}
      };

      // Listen for any changes to the URL of any tab.
      chrome.tabs.onUpdated.addListener(checkForValidUrl);
	  chrome.tabs.onSelectionChanged.addListener(function( tabId,  selectInfo) {
			//chrome.tabs.getSelected(null, function(tab) {
			  chrome.tabs.sendRequest(tabId, {
			  		action: "focus",
					stickiesActive:stickythang.getLocalStorage('stickiesActive'),
					notes:stickythang.db.listAll,
					shares:stickythang.shares
				}, function(response) {
			    console.log(response.message);
			  });
			//});		  	
	  });
	  
	  
chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    if (!stickythang.db.localdb){
		stickythang.db.init();
	}
	switch (request.action){
		case "getList" :
			stickythang.db.getList(sendResponse);
		break;
		case "getAll" : 
			stickythang.db.count(sendResponse);
		break;
		case "getShares" : 
			stickythang.db.getShares(sendResponse);
		break;
		case "remove" :
			stickythang.db.remove(request.id,sendResponse);
		break;
		case "save" :
			stickythang.db.save(request.ops,sendResponse);
		break;
		case "saveNew" :
			stickythang.db.saveNew(request.ops,sendResponse);
		break;
		case "updateUser" :
			stickythang.updateUser(request.user)
			sendResponse({message:"set"})
		break;
	}

});	  

window.stickythang = {
	user:'',bespokeCSS:"",shares:[],
	getLocalStorage:function(key,def){
		return localStorage[key] || def || ''
	},
	updateUser:function(user){
		localStorage["user"] = user;
		stickythang.user = user;
	}
}	
window.ids = []; 

YUI().use("io","json", function(Y) {
	
	window.stickythang.Y = Y;
	
	function onFailure(transactionid, response, arguments) {
	   console.log('not good'+ response.responseText)
	}
	// Subscribe to "io.failure".
	Y.on('io:failure', onFailure, Y, 'Transaction Failed');
	
	function onSuccess(transactionid, response, arguments) {
	   console.log('good:'+ response.responseText.match("You have been successfully logged in") +"\n\n"+ response.responseText)
	   return response.responseText.match("You have been successfully logged in")
	}	
	Y.on('io:success', onSuccess, Y, true);		
		
	stickythang.login = function(ops){
		
		localStorage.user = ops.user 
		localStorage.pass = ops.pass 
		console.log("ST!login{user:'"+ localStorage.user +"',pass:'"+ localStorage.pass +"'}")
		if (!localStorage.user || !localStorage.pass){
			return {responseText:'ST!invalid'}
		}
			
		// Subscribe to "io.success".
		
		var uri = "http://stickythang.com/phpBB3/ucp.php?mode=login";
	    var cfg = {
	        method: 'POST',
			sync: true,
	        form: {
				id : Y.one("#login"),
	            username: localStorage.user,
	            password: localStorage.pass,
				redirect: "index.php"
	        }
	    };
		return Y.io(uri, cfg);
	}
})
stickythang.stickiesActive = function(state){
	localStorage.stickiesActive = state;
	console.log("stickiesActive:"+state)
	chrome.tabs.getSelected(null, function(tab) {
	  chrome.tabs.sendRequest(tab.id, {action: "css", stickiesActive: state ,tabid: tab.id}, function(response) {
	    console.log(response.message);
	  });
	});		
}	
stickythang.db = {
		localdb:null,
		version:"1.0",
		tableName:"stickies",
		listAll:[],
		
		init: function(){

			stickythang.db.localdb = openDatabase("StickyThang-background", "", "StickyThangs!", 200000);
			console.log("open db version:"+stickythang.db.localdb.version)
			stickythang.db.open();
				
		},
		getList:function(sendResponse){
			console.log('Loading list');
		    stickythang.db.localdb.transaction(function(tx) {
		        tx.executeSql("SELECT id, note, url, timestamp FROM "+ stickythang.db.tableName, [], function(tx, result) {
		        	console.log("returing list :"+ result.rows.length);
					var list = [];
					for (var i = 0; i < result.rows.length; ++i) {
						list.push({note:result.rows.item(i).note,url:result.rows.item(i).url});
					}
					sendResponse({results:list,stickiesActive:stickythang.getLocalStorage('stickiesActive'),user:stickythang.getLocalStorage('user')})			
		        }, function(tx, error) {
		            console.log('Failed to retrieve notes from database - ' + error.message);
					sendResponse({results:[]});
		        });
		    });					
		},
		getAll:function(sendResponse){
			console.log('Loading stickies from getAll');
		    stickythang.db.localdb.transaction(function(tx) {
		        tx.executeSql("SELECT * FROM "+ stickythang.db.tableName, [], function(tx, result) {
		        	console.log("loading stikies :"+ result.rows.length);
					var list = [];
					for (var i = 0; i < result.rows.length; ++i) {
						list.push({
							id:result.rows.item(i).id
							,domain:result.rows.item(i).domain
							,note:result.rows.item(i).note
							,ops:result.rows.item(i).ops
							,path:result.rows.item(i).path
							,scope:result.rows.item(i).scope
							,timestamp:result.rows.item(i).timestamp
							,urlex:result.rows.item(i).urlex
							,user:result.rows.item(i).user
						});
						stickythang.db.listAll = list;
					}
					if (sendResponse) {
						sendResponse({
							list: stickythang.db.listAll,
							stickiesActive: stickythang.getLocalStorage('stickiesActive'),
							user: stickythang.getLocalStorage('user','me'),
							shares: stickythang.shares,
							message: 'success'
						})
					}
									
		        }, function(tx, error) {
					if (sendResponse)
			            sendResponse({message:error.massage,list:[]})
		            return;
		        });
		    });					
		},
		get:function(sendResponse){
			console.log('Loading stickies');
		    stickythang.db.localdb.transaction(function(tx) {
		        tx.executeSql("SELECT * FROM "+ stickythang.db.tableName, [] , function(tx, result) {
		        	console.log("loading stikies :"+ result.rows.length);
					var list = [];
					for (var i = 0; i < result.rows.length; ++i) {
						list.push({
							id:result.rows.item(i).id
							,domain:result.rows.item(i).domain
							,note:result.rows.item(i).note
							,ops:result.rows.item(i).ops
							,path:result.rows.item(i).path
							,scope:result.rows.item(i).scope
							,timestamp:result.rows.item(i).timestamp
							,url:result.rows.item(i).url
							,urlex:result.rows.item(i).urlex
							,user:result.rows.item(i).user
						});
						stickythang.db.listAll = list;
					}
					sendResponse({list:list,stickiesActive:stickythang.getLocalStorage('stickiesActive'),user:stickythang.getLocalStorage('user'),message:'success'})					
		        }, function(tx, error) {
		            sendResponse({message:error.massage,list:[]})
		        });
		    });					
		},
		getIds:function(){
			console.log('getting ids')
		    stickythang.db.localdb.transaction(function(tx) {
		        tx.executeSql("SELECT id, note, url, timestamp FROM "+ stickythang.db.tableName +"", [], function(tx, result) {
		        	console.log("returing list :"+ result.rows.length);
					window.ids = [];
					for (var i = 0; i < result.rows.length; ++i) {
						window.ids.push(result.rows.item(i).id);
					}			
		        }, function(tx, error) {
		            console.log('Failed to retrieve notes from database - ' + error.message);
					sendResponse({results:[]});
		        });
		    });					
		},
		getShares:function(sendResponse){
		    stickythang.db.localdb.transaction(function(tx) {
		        tx.executeSql("SELECT id, label, url FROM "+ stickythang.db.tableName +"_share", [], function(tx, result) {
		        	console.log("returing list :"+ result.rows.length);
					window.stickythang.shares = [];
					for (var i = 0; i < result.rows.length; ++i) {
						window.stickythang.shares.push({
							id:result.rows.item(i).id,
							label:result.rows.item(i).label,
							url:result.rows.item(i).url
						});
					}		
					if (sendResponse){
						sendResponse({results:stickythang.shares});
					}	
		        }, function(tx, error) {
		            console.log('Failed to retrieve notes from database - ' + error.message);
					if (sendResponse){
						sendResponse({results:[]});
					}
					
		        });
		    });				
		},
		count:function(sendResponse){
		    stickythang.db.localdb.transaction(function(tx) {
				tx.executeSql("DELETE FROM "+ stickythang.db.tableName + " where note = ''", []);
		        tx.executeSql("SELECT COUNT(*) FROM "+ stickythang.db.tableName, [], function(result) {
		        	// count exists loading stickies
					console.log('count - loading sticky-notes')
					stickythang.db.getIds();
		            stickythang.db.getShares();
		            stickythang.db.getAll(sendResponse);
		        }, function(tx, error) {
		        //    tx.executeSql("CREATE TABLE "+ stickythang.db.tableName +" (id TEXT, note TEXT, timestamp REAL, left TEXT, top TEXT, pathway TEXT, page TEXT, scope TEXT, state TEXT, class TEXT)", [], function(result) { 
		                //stickythang.loadNotes(); 
						console.log('no count - no notes to load');
						if (sendResponse){
							sendResponse({message:'no notes found',list:[]})
						} else {
							return "no notes found"
						}
		        //    });
		        });
		    });				
		},
		remove:function(id,sendResponse){			
	        stickythang.db.localdb.transaction(function (trans){
	            trans.executeSql("DELETE from "+ stickythang.db.tableName +" WHERE id = ?", 
					[id],
					function(){
						stickythang.db.getAll();
						sendResponse({message:'removed'})
					},
					function(tx,error){
						sendResponse(error)
				});
	        });			
		},
		save:function(note,sendResponse){			
	        stickythang.db.localdb.transaction(function (trans){
	            trans.executeSql("UPDATE "+ stickythang.db.tableName +" SET note = ?, ops = ?, scope = ?, timestamp = ? WHERE id = ?", 
					[note.html, note.json, note.scope, note.timestamp , note.id],
					function(){
						stickythang.db.getAll();
						sendResponse({message:'updated'})
					},
					function(tx,error){
						sendResponse(error)
				});
	        });			
		},
		saveNew:function(note,sendResponse){			
			console.log('trying to save a new note');
			if (!note.html || note.html == ''){
				//sendResponse({message:'!!!!note empty, not creating'})
			}
	        stickythang.db.localdb.transaction(function (trans){
	            trans.executeSql("INSERT INTO "+ stickythang.db.tableName +" (id, domain, note, ops, path, querystring, scope, timestamp, url, user) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", 
					[note.id, note.domain, note.html, note.json, note.path, note.querystring, note.scope, note.timestamp, note.href , stickythang.user],
					function(){
						stickythang.db.getAll();
						sendResponse({message:'inserted'})
					},
					function(tx,error){
						console.log(error.message)
						sendResponse(error)
				});
	        });			
		},
		updateShare:function(){
			//var dataverson = stickythang.getLocalStorage('dataversion');
			var Y = stickythang.Y;
			console.log("updating share")
			var uri = "http://stickythang.com/lib/test.js",
				cfg = {
			        sync: true
			    };
			var request = Y.io(uri, cfg);
			var shareRS = Y.JSON.parse(request.responseText);
			console.log("updating share...")
			stickythang.db.localdb.transaction(function (trans){
				trans.executeSql("delete from "+ stickythang.db.tableName +"_share",[],
					function(){},
					function(tx,error){
						console.log(error.message)
					});
				for (name in shareRS){
					rs = shareRS[name];
		            trans.executeSql("INSERT INTO "+ stickythang.db.tableName +"_share (id, label, url) VALUES (?, ?, ?)",[rs.id, rs.label, rs.url],
					function(){},
					function(tx,error){
						console.log(error.message)
					});
				};
				stickythang.db.getShares();// update the list
			});
		},
		open: function(){
			// open db assume it's the first time
			stickythang.db.localdb.transaction(function(trans){
				console.log("db.open.trans connection open")
				trans.executeSql('CREATE TABLE IF NOT EXISTS '+ stickythang.db.tableName +' '+
					'	(id TEXT, '+
					'	domain TEXT, '+
					'	note TEXT, '+
					'	ops TEXT, '+
					'	path TEXT, '+
					'	querystring TEXT, '+
					'	scope TEXT, '+
					'	timestamp REAL, '+
					'	url TEXT, '+
					'	urlex TEXT, '+
					'	user TEXT '+
					');',[],function(){
							console.log("db.open.trans connection open and returned")
						},function(tx,e){
							console.log("db.open.trans connection open and returned an error "+ tx +"\n"+ stickythang.explode(e))
						});
				trans.executeSql('CREATE TABLE IF NOT EXISTS '+ stickythang.db.tableName +'_share '+
					'	(id TEXT, '+
					'	label TEXT, '+
					'	url TEXT '+
					');',[],function(){
							console.log("db.open.trans connection open and returned")
						},function(tx,e){
							console.log("db.open.trans connection open and returned an error "+ tx +"\n"+ stickythang.explode(e))
						});
			});
		}
	};	
	 
	  
	  
	  
	
	  
  
	  
	  
	  
	  
    </script>



















  </head>

<body><form action="http://stickythang.com/phpBB3/ucp.php?mode=login" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p>
					<label>Login with...</label>
					<select>
						<option>StickyThang!</option>
						<option>Google</option>
						<option>FaceBook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<p>
					<label for="username">User:</label><input value="tester" type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input value="password" type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" id="loginButton" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
			</form></body>
</html>