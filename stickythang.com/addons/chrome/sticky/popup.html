<!DOCTYPE html>
<!-- /*
Copyright (c) 2011, P Clancey. All rights reserved.
Code licensed under the BSD License:
http://www.opensource.org/licenses/bsd-license.php
version: alpha 0.1
*/ -->	
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>popup</title>
		<script src="lib/yui/3.4.0/build/yui/yui.js"></script>
		<link href="lib/css/popup.css" rel="stylesheet" />
		
		<style type="text/css">
			a.strip * {display:inline;}
			p.create {
				border-top:1px dashed #cecece;
				margin-top:10px;
				padding:15px 0;
			}
			p.create input {
				font-size:50px;
			}
			#stickyList a {
				display:block;
			}
			label.auto {
				width:auto;
			}
			

div.bottom {
	background: #121A28 url(http://stickythang.com/assets/templates/drupify/images/bottom-bg.png) 0 0 repeat-x;
	border-radius:0 0 10px 10px ;
	color:#888;
	font-size:120%;
	padding:14px 0 10px;
	text-align:center;
}
div.bottom a {
	color:inherit
}
			
			
			
		</style>
		
	</head>
	
	
	

	<body>
		<h1 class="centre"><a href="http://stickythang.com" target="_blank"><span>StickyThang!</span></a></h1>
		<ul class="menu" dir="rtl">
			<li class="active"><a class="MyStickies"><span>My stickies</span></a></li>
			<li class=""><a class="AllStickies"><span>Friends stickies</span></a></li>
			<li><a class="LoginForm"><span>Login</span></a></li>
		</ul>
		<div id="LoginForm" class="off unit">
			<form action="http://stickythang.com/phpBB3/ucp.php?mode=login" target="hiddenframe" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p>
					<label>Login with...</label>
					<select disabled="true">
						<option>StickyThang!</option>
						<option>Google</option>
						<option>FaceBook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<p>
					<label for="username">User:</label><input value="tester" type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input value="password" type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" id="loginButton" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
			</form>
			
		</div>
		<div id="MyStickies" class="on unit">
			<div>
				<h2>My stickies <span id="domainLable"></span></h2>
				<div id="myList" class="menu">
				</div>
				<ul id="stickyList">
					
				</ul>
				<style>
p.button {
background-image: url(http://stickythang.com/lib/i/misc/button.png);
background-repeat: no-repeat;
background-position:50% 0;
padding: 0;
text-align:center;
}	
p.button input {
	background-color:transparent;
	border:0 none;
	color:#fff;
	height: 48px;
	font-size:19px;
	margin-bottom:10px;
	text-align:center;
	width: 220px;
}				
				</style>
				<p class="button">
					<input type="button" id="addNote" value=" Add a new Sticky! " />
				</p>
				<!-- p class="centre">
					NB: You'll need to login inorder to share your notes.
				</p -->
				<p>
					<label class="auto"><input type="checkbox" value="" id="inputHideAll" /> Hide all stickies </label>
				</p>
			</div>
		</div>
		<div id="AllStickies" class="off unit">
			<div>
				<h2>All stickies</h2>
				<div id="allList" class="menu">
					
				</div>
	
			</div>
		</div>
		<div class="tac bottom">
			<a target="_blank" href="options.html">Open Options</a>
			|
			<a target="_blank" href="http://stickythang.com/">Visit StickyThang!</a>
		</div>
	</body>
		<script>
			var background = chrome.extension.getBackgroundPage().window;
			
			YUI().use('node','yql','json-parse','node-load',function(Y){
				var loader = {
					LoadList:function(results){
						console.log('ST!' + results.list.length)
						loader.populateList(results);
					},
					populateList:function(response){
						var rs = response.list,
							html = "",
							note = "",
							mxlen = 140,
							url;
			            for (var i = 0; i < rs.length; ++i) {
							note = rs[i].note.replace(/<[^>]*>?/g," ");
							note = note.length > mxlen ? note.substring(0,mxlen)+"..." : note;
							url = rs[i].url
							if (note && note!="undefined" && url && url!="undefined")
								html+= '<li><a target="_blank" class="strip" href="'+ rs[i].url +'">'+ note  +'</a></li>';
			            }
						Y.one("#stickyList").setContent(html);
						// Y.one("#domainLable").setContent(response.domain)
					}	
				}
				background.stickythang.db.get(loader.LoadList);

				/*
				 * TODO, make friends db and getFriends method
				
				var friends = ['tester','patrick'];
				for (var i = 0; i<friends.length ; i++ ){
					// Y.one('#myList').setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>").load("http://stickythang.com/phpBB3/search.php?author=tester")
				}
				*/
				
				Y.one('#allList')
					.setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>")
					//.load("http://stickythang.com/phpBB3/search.php?keywords=&terms=all",null,function(){
						// Y.one('#allList').setContent( this.get("id") );
					//})	
				
				Y.one("#addNote").on('click',function(e){
					e.preventDefault();
					chrome.tabs.getSelected(null, function(tab) {
					  chrome.tabs.sendRequest(tab.id, {action: "create-note", tabid: tab.id}, function(response) {
					    console.log(response.data);
						window.close();
					  });
					});			
				});
				Y.all("ul.menu a").on("click",function(e){
					e.preventDefault();
					var target = e.currentTarget;
					
					Y.all("ul.menu li").removeClass("active");
					target.ancestor("li").addClass("active")
					
					Y.all("div.unit").addClass("off")
					Y.one("#"+ target.get("className") ).removeClass("off");
					
				});
				Y.one("#inputHideAll").on('click',function(){
					var hide = Y.one("#inputHideAll").get("checked");
					if(hide){
						background.stickythang.stickiesActive('hide');
					} else {
						background.stickythang.stickiesActive('show');
					}
				});
				console.log(background.stickythang.getLocalStorage('stickiesActive'))
				if (background.stickythang.getLocalStorage('stickiesActive') == 'hide'){
					Y.one("#inputHideAll").set("checked","true")
				}else {
					console.log(background.stickythang.getLocalStorage('stickiesActive'))
				}
				
				Y.one("#loginButton").on('click',function(e){
					e.preventDefault();
					// Y.one("#loginButton").set('value',typeof background.window)
					// return;
					try {
						var v = background.stickythang.login({
							user:Y.one("#username").get('value')
							,pass:Y.one("#password").get('value')
						})
						if ( v.responseText == 'ST!invalid'){
							Y.one("#loginButton").set('value','Please add your details')
						} else if ( v.responseText.match("You have been successfully logged in") ){
							Y.one("#loginButton").set('value','Login successful!')
						} else if ( v.responseText.match("<title>stickythang.com &bull; Index page</title>") ) {
							Y.one("#loginButton").set('value','You alredy have an active session').setAttribute('disabled','disabled')
						} else {
							Y.one("#loginButton").set('value','Not sure what the status is : ( ');
							console.log(v.responseText)
						}
						
					}catch(e){
						Y.one("#loginButton").set('value','e:'+e.message)
					}
					
				})
				/*
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {action: "get-list", tabid: tab.id}, function(response) {
				    populateList(response);
				  });
				});	
				*/

				//populateList()
				
				Y.YQL('select * from feed where url="http://stickythang.com/phpBB3/feed.php?f=2&t=2"', (function(inner) {
					return function(r) {
						//var inner = mod.one('div.inner')
		                if (r && r.query && r.query.results) {
		                    
			                var html = '',
								obj = {},
								str;
		                    
		                    //Walk the list and create the news list
		                    Y.each(r.query.results, function(items) {
		                        Y.each(items, function(v, k) {
		                            if (1) {
		                                if (v.content && v.content.content) {
		                                   v.content = v.content.content.replace(/&quot;/g,'"').replace(/(\r\n|\n|\r)/g,"");
		                                }
										obj = Y.JSON.parse( v.content );
										if (obj.text)
		                                	html += Y.Lang.sub('<li><a href="{url}" target="_blank">{text}</a>', obj);
										//html+= "<li><textarea>"+ obj.className +"\n"+ temp  +"\n"+ (v.content == temp) +"</textarea></li>"
		                            }
		                        });
		                    });
		                    //Set the innerHTML of the module
		                    inner.set('innerHTML', '<ul>' + html + '</ul>');
		                }else{
							inner.set('innerHTML', '<ul>problems :( </ul>');
						}
		            }
		        })(Y.one("#allList")));	
			        
			      
			});
		</script>	
</html>
