<!DOCTYPE html>
<!-- /*
Copyright (c) 2011, P Clancey. All rights reserved.
Code licensed under the BSD License:
http://www.opensource.org/licenses/bsd-license.php
version: alpha 0.1
*/ -->	
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>stickythang popup</title>
		<script src="lib/yui/3.4.0/build/yui/yui-min.js"></script>
		<link href="lib/css/popup.css" rel="stylesheet" />
		
		<style type="text/css">
			a.strip * {display:inline;}
			p.create {
				border-top:1px dashed #cecece;
				margin-top:10px;
				padding:15px 0;
			}
			p.create input {
				font-size:50px;
			}
			#stickyList a {
				display:block;
			}
			label.auto {
				width:auto;
			}
			

div.bottom {
	background: #121A28 url(http://stickythang.com/assets/templates/drupify/images/bottom-bg.png) 0 0 repeat-x;
	border-radius:0 0 10px 10px ;
	color:#888;
	font-size:120%;
	padding:14px 0 10px;
	text-align:center;
}
div.bottom a {
	color:inherit
}
			
			
			
		</style>
		
	</head>
	
	
	

	<body>
		<h1 class="centre"><a href="http://stickythang.com" target="_blank"><span>StickyThang!</span></a></h1>
		<ul class="menu" dir="rtl">
			<li class="active"><a class="MyStickies"><span>My stickies</span></a></li>
			<li class=""><a class="AllStickies"><span>Friends stickies</span></a></li>
			<li><a class="LoginForm"><span>Login/Feedback </span></a></li>
		</ul>
		<div id="LoginForm" class="off unit">
			<form action="http://stickythang.com/phpBB3/ucp.php?mode=login" target="hiddenframe" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p id="loginStatus">
					<label>Login with...</label>
					<select disabled="true">
						<option>StickyThang!</option>
						<option>Google</option>
						<option>Facebook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<div id="loginInputArea">					
				<p>
					<label for="username">User:</label><input value="" type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input value="" type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" id="loginButton" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
				</div>
			</form>
			<div style="margin-top:8px;padding-bottom:8px;border-top:1px solid #e2e2e2"></div>
			<div style="min-height:40px;">
				<form id="feedback" action="http://stickythang.com/index.php?id=3" method="post">
					<input type="hidden" name="name" id="name" />
					<input type="hidden" name="email" value="feedback@stickthang.com" />
					<p>
						<label for="type">Type:</label>
						<select id="type">
							<option>General</option>
							<option>Bug</option>
							<option>Suggestion / feature request</option>
						</select>
					</p>
					<textarea name="text" id="text"></textarea>
					<p>
						<input type="submit" value="send feedback" />
					</p>
				</form>
				<h2 style="opacity:0;display:none;" id="h2feedbackthanks">Thanks your for feedback</h2>
			</div>
			
		</div>
		<div id="MyStickies" class="on unit">
			<div>
				<div id="divUpdateUserName">
					<div class="absolute">
						<form id="setUserName">
						<h2>Please enter your stickythang user name</h2>
						<input type="text" id="userNameInput" value="" />
						<input type="submit" value="User name" id="userNameButton" />
						</form>
					</div>
				</div>
				<p class="button">
					<input type="button" id="addNote" value=" Add a new Sticky! " />
				</p>
				<h2>My stickies <span id="domainLable"></span></h2>				
				<div style="max-height:240px;overflow:auto">
				<ul id="stickyList">
					
				</ul></div>				
				<!-- p class="centre">
					NB: You'll need to login inorder to share your notes.
				</p -->
				<p>
					<label class="auto"><input type="checkbox" value="" id="inputHideAll" /> Hide all stickies </label>
				</p>
			</div>
		</div>
		<div id="AllStickies" class="off unit">
			<div>
				<h2>Friends stickies</h2>
				<div id="allList" class="menu">
					<ul id="ulAllList"></ul>
				</div>
	
			</div>
		</div>
		<div class="tac bottom">
			<a target="_blank" href="options.html">Open Options</a>
			|
			<a target="_blank" href="http://stickythang.com/">Visit StickyThang!</a>
		</div>
	</body>
		<script>
			var background = chrome.extension.getBackgroundPage().window,
				username = background.stickythang.getLoggedInUser();
			
				console.log('current user:'+username);
				
			
			YUI().use('node','yql','io-form','json-parse','node-load','transition',function(Y){
				/*
				if ( 1 || !background.stickythang.getLocalStorage('user') ){
					
					Y.one("#divUpdateUserName").setStyle("display","block");
					Y.one("#setUserName").on("submit",function(e){
						e.preventDefault();
						var u = Y.one("#userNameInput").get('value');
						background.stickythang.updateUser(u);
						Y.one("#username").set('value',u);
						Y.one("#divUpdateUserName").transition({
							duration:0.5,
							opacity:0
						},function(){
							this.remove();
						})
					});
					
				} else {
					Y.one("#username").set('value',background.stickythang.getLocalStorage('user'));
				}
				*/
				if (window.username){
					Y.one("#username").set('value',username);
				}
				var loader = {
					LoadList:function(results){
						console.log('ST!' + results.list.length)
						loader.populateList(results);
					},
					populateList:function(response){
						var rs = response.list,
							html = "",
							note = "",
							mxlen = 140,
							url;
			            for (var i = 0; i < rs.length; ++i) {
							if (!rs[i].note){continue}
							note = rs[i].note.replace(/<[^>]*>?/g," ");
							note = note.length > mxlen ? note.substring(0,mxlen)+"..." : note;
							url = rs[i].url
							if (note && note!="undefined" && url && url!="undefined"){
								html+= '<li><a target="_blank" class="strip" href="'+ rs[i].url +'">'+ note  +'</a></li>';
							}
			            }
						Y.one("#stickyList").setContent(html);
						// Y.one("#domainLable").setContent(response.domain)
					}	
				}

				background.stickythang.db.get(loader.LoadList);

				/*
				 * TODO, make friends db and getFriends method
				
				var friends = ['tester','patrick'];
				for (var i = 0; i<friends.length ; i++ ){
					// Y.one('#myList').setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>").load("http://stickythang.com/phpBB3/search.php?author=tester")
				}
				*/
				
				Y.one('#ulAllList')
					.setContent("<li id=liAllListLoading class=centre><img src='lib/i/8-0.gif' /></li>")
					//.load("http://stickythang.com/phpBB3/search.php?keywords=&terms=all",null,function(){
						// Y.one('#allList').setContent( this.get("id") );
					//})	
				
				Y.one("#addNote").on('click',function(e){
					e.preventDefault();
					chrome.tabs.getSelected(null, function(tab) {
					  chrome.tabs.sendRequest(tab.id, {action: "create-note", tabid: tab.id}, function(response) {
					    console.log(response.data);
						window.close();
					  });
					});			
				});
				Y.all("ul.menu a").on("click",function(e){
					e.preventDefault();
					var target = e.currentTarget;
					
					Y.all("ul.menu li").removeClass("active");
					target.ancestor("li").addClass("active")
					
					Y.all("div.unit").addClass("off")
					Y.one("#"+ target.get("className") ).removeClass("off");
					
				});
				Y.one("#inputHideAll").on('click',function(){
					var hide = Y.one("#inputHideAll").get("checked");
					if(hide){
						background.stickythang.stickiesActive('hide');
					} else {
						background.stickythang.stickiesActive('show');
					}
				});
				console.log(background.stickythang.getLocalStorage('stickiesActive'))
				if (background.stickythang.getLocalStorage('stickiesActive') == 'hide'){
					Y.one("#inputHideAll").set("checked","true")
				}else {
					console.log(background.stickythang.getLocalStorage('stickiesActive'))
				}
				// Y.one("#name").set("value",background.stickythang.getLocalStorage('user'));
				Y.one("#feedback").on('submit',function(e){
					e.preventDefault();
					var uri = Y.one("#feedback").getAttribute("action");
				    var cfg = {
				        method: 'POST',
				        form: {
				            id: "feedback"
				        }
				    };
				    Y.io(uri, cfg);			
					Y.one("#feedback").transition({
						    easing: 'linear',
							height:{
						        delay: 0.5,
						        duration: 0.5,
						        value: 0
						    },
						    opacity: {
						        delay: 0.5,
						        duration: 0.5,
						        value: 0
						    }
						},function(){
							Y.one("#h2feedbackthanks").setStyle("display","block").transition({
						    easing: 'linear',
						    opacity: {
						        duration: 0.5,
						        value: 1
						    }
						})
					})		
				})
				Y.one("#loginButton").on('click',function(e){
					e.preventDefault();
					// Y.one("#loginButton").set('value',typeof background.window)
					// return;
					try {
						var v = background.stickythang.login({
							user:Y.one("#username").get('value')
							,pass:Y.one("#password").get('value')
						})
						if ( v.responseText == 'ST!invalid'){
							Y.one("#loginButton").set('value','Please add your details')
						} else if ( v.responseText.match("You have been successfully logged in") ){
							Y.one("#loginButton").set('value','Login successful!')
						} else if ( v.responseText.match("<title>stickythang.com &bull; Index page</title>") ) {
							Y.one("#loginButton").set('value','You alredy have an active session').setAttribute('disabled','disabled')
						} else {
							Y.one("#loginButton").set('value','Not sure what the status is : ( ');
							console.log(v.responseText)
						}
						
					}catch(e){
						Y.one("#loginButton").set('value','e:'+e.message)
					}
					
				})
	
				function CheckLoginStatus(){
					console.log('checking login status:')
					Y.one("#loginInputArea").setStyle('display','none');
					var html = "",
						u = background.stickythang.getLoggedInUser('user');
						
						if ( !u ){// it's a sticky thang response
							html = 'Not logged in, <a target="_blank" href="options.html">Login/Register</a>';
							// Y.one("#loginInputArea").setStyle('display','block');
						} else {
							// html = 'Status, unknown';
							html = 'Logged in as, '+ u;
							// Y.one("#loginInputArea").setStyle('display','block');
							Y.one("#loginStatus").setContent(html);
						}						
				}
				CheckLoginStatus()

				/*
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {action: "get-list", tabid: tab.id}, function(response) {
				    populateList(response);
				  });
				});	
				*/

				//populateList()
				
//				Y.YQL('select * from feed where url="http://stickythang.com/phpBB3/feed.php?f=2&t=4"', (function(inner) {
				Y.YQL('select * from feed where url="http://stickythang.com/phpBB3/feed.php?mode=topics"', (function(inner) {
					
					return function(r) {
						//var inner = mod.one('div.inner')
		                if (r && r.query && r.query.results) {
		                    
			                var html = '',
								obj = {name:"blah",content:'blah blah'},
								str,
								array = [];
								
								inner.one("#liAllListLoading").remove();
		                    
		                    //Walk the list and create the news list
		                    Y.each(r.query.results, function(items) {
		                        Y.each(items, function(v, k) {
		                            if (k < items.length) {
		                                if (v.content && v.content.content) {
		                                   v.content = v.content.content //.replace(/&quot;/g,'"').replace(/(\r\n|\n|\r)/g,"").replace(/<(.|\n)*?>/g,"");
		                                }
										if (v.author && v.author.name){
											v.name = v.author.name;
										}
										if (v.title && v.title.content){
											v.title = v.title.content.replace(/&amp;nbsp;/g,' ')
										}
										if (v.id && v.id.content){
											v.id = v.id.content;
										}
										try {
											obj = Y.JSON.parse(v.content.replace(/&quot;/g,'"'));
											obj.name = v.name;
											obj.title = v.title || "";
											obj.urlex = v.id || ""; 
											
											if (obj && obj.name != window.username && obj.id && background.stickythang.db.isBubby(obj.name) ){
												array.push(Y.Lang.sub('<li><strong>{name}:</strong> <a href="{href}" target="_blank" title="{stURI}">{title}</a></li>', obj));
												inner.append(Y.Lang.sub('<li><strong>{name}:</strong> <a id="link-to-{id}" ref="{href}" target="_blank" title="link-to-{id}">{title}</a></li>', obj))
												var O = obj;
												Y.one("#link-to-"+O.id).on('click',function(e){
													e.preventDefault();
													console.log( "#link-to-"+O.id )
													if ( Y.one("#link-to-"+O.id) ){
														console.log('trying to save new note with id:'+ O.id)
														background.stickythang.saveNewIfNotExists(O);
													}
												})
											}
										}catch(e){
											// array.push('<li>'+ e +':'+ '</li>');
										}
		                            }
		                        });
		                    });
							html = array.reverse().join('')
		                    //Set the innerHTML of the module
		                    //inner.set('innerHTML', '<ul>' + html + '</ul>');
		                }else{
							inner.set('innerHTML', '<li>problems :( </li>');
						}
		            }
		        })(Y.one("#ulAllList")));	
			        
			      
			});
		</script>	
</html>
