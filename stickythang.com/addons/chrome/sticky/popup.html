<!DOCTYPE html>
<!-- /*
Copyright (c) 2011, P Clancey. All rights reserved.
Code licensed under the BSD License:
http://www.opensource.org/licenses/bsd-license.php
version: 0.1
*/ -->	
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>stickythang popup</title>
		<script src="lib/yui/3.4.0/build/yui/yui-min.js"></script>
		<link href="lib/css/popup.css" rel="stylesheet" />
		
		<style type="text/css">
			a.strip * {display:inline;}
			p.create {
				border-top:1px dashed #cecece;
				margin-top:10px;
				padding:15px 0;
			}
			p.create input {
				font-size:50px;
			}
			#stickyList a {
				display:block;
			}
			label.auto {
				width:auto;
			}
			div.bottom {
				background: #121A28 url(http://stickythang.com/assets/templates/drupify/images/bottom-bg.png) 0 0 repeat-x;
				border-radius:0 0 10px 10px ;
				color:#888;
				font-size:120%;
				padding:14px 0 10px;
				text-align:center;
			}
			div.bottom a {
				color:inherit
			}
			body {display: block;}
			
			h1 {
				height:2px;
				overflow:hidden;
				visibility:hidden;
			}
			div.menu li span.del {
				background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADtSURBVHjajFC7DkFREJy9iXg0t+EHRKJDJSqRuIVaJT7AF+jR+xuNRiJyS8WlRaHWeOU+kBy7eyKhs8lkJrOzZ3OWzMAD15gxYhB+yzAm0ndez+eYMYLngdkIf2vpSYbCfsNkOx07n8kgWa1UpptNII5VR/M56Nyt6Qq33bbhQsHy6aR0WSyEyEmiCG6vR2ffB65X4HCwYC2e9CTjJGGok4/7Hcjl+ImLBWv1uCRDu3peV5eGQ2C5/P1zq4X9dGpXP+LYhmYz4HbDMQgUosWTnmQoKKf0htVKBZvtFsx6S9bm48ktaV3EXwd/CzAAVjt+gHT5me0AAAAASUVORK5CYII=);
				display:inline-block;
				float:right;
				height:10px;
				margin-top:2px;
				width:10px;
			}
			#ulAllList div.menu li a {
				display:block;
				padding: 2px 10px 4px 0;
			}
			#ulAllList div.menu li {
				padding: 0;
			}
		</style>
		
	</head>

	<body>
		<h1 class="centre"><a href="http://stickythang.com" target="_blank"><span>StickyThang!</span></a></h1>
		<ul class="menu">
			<li class="active"><a class="MyStickies"><span>My stickies</span></a></li>
			<li class=""><a class="AllStickies"><span>Friends stickies</span></a></li>
			<li><a class="LoginForm"><span>Login/Feedback </span></a></li>
		</ul>
		<div id="LoginForm" class="off unit">
			<form action="/" target="hiddenframe" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p id="loginStatus">
					<label>Login with...</label>
					<select disabled="true">
						<option>StickyThang!</option>
						<option>Google</option>
						<option>Facebook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<div id="loginInputArea">
				<p>
					<label for="username">User:</label><input value="" type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input value="" type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" id="loginButton" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
				</div>
			</form>
			<div style="margin-top:8px;padding-bottom:8px;border-top:1px solid #e2e2e2"></div>
			<div style="min-height:40px;">
				<form id="feedback" action="http://stickythang.com/contact" method="post">
					<input type="hidden" name="name" id="name" />
					<input type="hidden" name="email" value="feedback@stickythang.com" />
					<legend>Give feedback</legend>
					<p>
						<label for="type">Type:</label>
						<select id="type" name="type">
							<option>General</option>
							<option>Bug</option>
							<option>Suggestion / feature request</option>
						</select>
					</p>
					<textarea name="text" id="text"></textarea>
					<p>
						<input type="submit" value="send feedback" />
					</p>
				</form>
				<h2 style="opacity:0;display:none;" id="h2feedbackthanks">Thanks your for feedback</h2>
			</div>
			
		</div>
		<div id="MyStickies" class="on unit">
			<div>
				<div id="divUpdateUserName">
					<div class="absolute">
						<form id="setUserName">
						<h2>Please enter your stickythang user name</h2>
						<input type="text" id="userNameInput" value="" />
						<input type="submit" value="User name" id="userNameButton" />
						</form>
					</div>
				</div>
				<p class="button">
					<input type="button" id="addNote" value=" Add a new Sticky! " />
				</p>
				<h2>Recent stickies <span id="domainLable"></span></h2>				
				<div style="max-height:240px;overflow:auto">
				<ul id="stickyList">
					
				</ul></div>				
				<!-- p class="centre">
					NB: You'll need to login inorder to share your notes.
				</p -->
				<p>
					<label class="auto"><input type="checkbox" value="" id="inputHideAll" /> Hide all stickies </label>
				</p>
			</div>
		</div>
		<div id="AllStickies" class="off unit">
			<div>
				<h2 id="h2buddyTitle">Friends stickies</h2>
				<div id="allList" class="menu">
					<ul id="ulAllList"></ul>
				</div>
	
			</div>
		</div>
		<div class="tac bottom">
			<a target="_blank" href="options.html">Open Options</a>
			<!--
			|
			<a target="_blank" href="http://stickythang.com/">Visit StickyThang!</a>
			-->
		</div>
	</body>
		<script>
			var background = chrome.extension.getBackgroundPage().window,
				username = background.stickythang.getLoggedInUser(),
				buddies = background.stickythang.db.getBuddies(),
				debug = 0;
			
				console.log('current user:'+username);
				
			
			YUI().use('node','yql','io-form','json-parse','node-load','transition',function(Y){
				/*
				if ( 1 || !background.stickythang.getLocalStorage('user') ){
					
					Y.one("#divUpdateUserName").setStyle("display","block");
					Y.one("#setUserName").on("submit",function(e){
						e.preventDefault();
						var u = Y.one("#userNameInput").get('value');
						background.stickythang.updateUser(u);
						Y.one("#username").set('value',u);
						Y.one("#divUpdateUserName").transition({
							duration:0.5,
							opacity:0
						},function(){
							this.remove();
						})
					});
					
				} else {
					Y.one("#username").set('value',background.stickythang.getLocalStorage('user'));
				}
				*/
				if (window.username){
					Y.one("#username").set('value',username);
				}
				var loader = {
					LoadList:function(results){
						console.log('ST!' + results.list.length)
						loader.populateList(results);
					},
					populateList:function(response){
						var rs = response.list,
							myStickies = "",
							buddiesStickies = "",
							mxlen = 140;
						for (var i = rs.length-1; i >= 0; i--) {
							var sticky = rs[i],
								note="",
								url="",
								user;
							if (!sticky.note){continue}
							note = sticky.note.replace(/<[^>]*>?/g," ");
							note = note.length > mxlen ? note.substring(0,mxlen) + "..." : note;
							url = sticky.url;
							user = sticky.user || "";
							if (note && sticky.urlex){
								buddiesStickies+= '<li><a target="_blank" class="strip" href="'+ rs[i].url +'"><span id="span'+rs[i].id+'" class="del"></span>'+ user +'; '+ note  +'</a></li>';
							} else if (note){
								myStickies+= '<li><a target="_blank" class="strip" href="'+ rs[i].url +'">'+ note  +'</a></li>';
							}
						}
						if (!myStickies){myStickies = "<li>You have no saved stickies</li>"}
						if (!buddiesStickies){buddiesStickies = "<li>No stickies found</li>"}
						Y.one("#stickyList").setContent(myStickies);
						Y.one('#ulAllList').setContent(buddiesStickies);
						// Y.one("#domainLable").setContent(response.domain)
						Y.one('#ulAllList').delegate('click',function(e){
							e.preventDefault()
							var id = e.currentTarget.getAttribute('id').substring(4),
								li = e.currentTarget.ancestor('li');
								
							li.setStyle('overflow','hidden').transition({height:0,opacity:0},function(){this.remove()})
							console.log("deleting item with id:"+id)
							background.stickythang.db.remove(id,null);
						},"span.del");
					}	
				}

				background.stickythang.db.get(loader.LoadList);

				/*
				 * TODO, make friends db and getFriends method
				
				var friends = ['tester','patrick'];
				for (var i = 0; i<friends.length ; i++ ){
					// Y.one('#myList').setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>").load("http://stickythang.com/phpBB3/search.php?author=tester")
				}
				*/
				
				Y.one('#ulAllList')
					.setContent("<li id=liAllListLoading class=centre><img src='lib/i/8-0.gif' /></li>")
				
				Y.one("#addNote").on('click',function(e){
					e.preventDefault();
					chrome.tabs.getSelected(null, function(tab) {
					  chrome.tabs.sendRequest(tab.id, {action: "create-note", tabid: tab.id}, function(response) {
					    console.log(response.data);
						window.close();
					  });
					});			
				});
				Y.all("ul.menu a").on("click",function(e){
					e.preventDefault();
					var target = e.currentTarget;
					
					Y.all("ul.menu li").removeClass("active");
					target.ancestor("li").addClass("active")
					
					Y.all("div.unit").addClass("off")
					Y.one("#"+ target.get("className") ).removeClass("off");
					
				});
				Y.one("#inputHideAll").on('click',function(){
					var hide = Y.one("#inputHideAll").get("checked");
					if(hide){
						background.stickythang.stickiesActive('hide');
					} else {
						background.stickythang.stickiesActive('show');
					}
				});
				console.log(background.stickythang.getLocalStorage('stickiesActive'))
				if (background.stickythang.getLocalStorage('stickiesActive') == 'hide'){
					Y.one("#inputHideAll").set("checked","true")
				}else {
					console.log(background.stickythang.getLocalStorage('stickiesActive'))
				}
				// Y.one("#name").set("value",background.stickythang.getLocalStorage('user'));
				Y.one("#feedback").on('submit',function(e){
					e.preventDefault();
					var uri = Y.one("#feedback").getAttribute("action");
				    var cfg = {
				        method: 'POST',
				        form: {
				            id: "feedback"
				        }
				    };
				    Y.io(uri, cfg);			
					Y.one("#feedback").transition({
						    easing: 'linear',
							height:{
						        delay: 0.5,
						        duration: 0.5,
						        value: 0
						    },
						    opacity: {
						        delay: 0.5,
						        duration: 0.5,
						        value: 0
						    }
						},function(){
							Y.one("#h2feedbackthanks").setStyle("display","block").transition({
						    easing: 'linear',
						    opacity: {
						        duration: 0.5,
						        value: 1
						    }
						})
					})		
				})
				function Login(e){
					e.preventDefault();
					
					// Y.one("#loginButton").set('value',typeof background.window)
					// return;
					try {
						var v = background.stickythang.login({
							user:Y.one("#username").get('value')
							,pass:Y.one("#password").get('value')
						})
						if ( v.responseText == 'ST!invalid'){
							Y.one("#loginButton").set('value','Incorrect username or password')
						} else if ( v.responseText.match("You have been successfully logged in") ){
							Y.one("#loginButton").set('value','Login successful')
						} else if ( v.responseText.indexOf('{"user":') == 0 ) {
							var obj = Y.JSON.parse(v.responseText)
							// user aleady had a logged in session, get logged in user name
							Y.one("#loginButton").set('value','Logged in as '+obj.user);
						} else {
							Y.one("#loginButton").set('value','Could not login : ( ');
							console.log(v.responseText)
						}
						
					}catch(e){
						Y.one("#loginButton").set('value','e:'+e.message)
					}				
				}
				Y.one("#login").on('submit',Login);
	
				function CheckLoginStatus(){
					console.log('checking login status:')
					
					
					var html = "",
						u = background.stickythang.getLoggedInUser();
						
						if ( !u ){// it's a sticky thang response
							html = 'To share stickies you need to login below or <a target="_blank" href="options.html">register</a>.';
							// Y.one("#loginInputArea").setStyle('display','block');
							// Y.one('#ulAllList').setContent('<li>You need to login to see your friends stickies</li><li><a target="_blank" href="options.html">register</a></li>')
						} else {
							// html = 'Status, unknown';
							html = 'Logged in as, '+ u;
							Y.one("#loginInputArea").setStyle('display','none');
						}
						Y.one("#loginStatus").setContent(html);
				}
				CheckLoginStatus()
			});
		</script>	
</html>
