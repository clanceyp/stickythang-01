<!DOCTYPE html>
<!-- /*
Copyright (c) 2011, P Clancey. All rights reserved.
Code licensed under the BSD License:
http://www.opensource.org/licenses/bsd-license.php
version: alpha 0.1
*/ -->	
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>popup</title>
		<script src="lib/yui/3.4.0/build/yui/yui.js"></script>
		<link href="lib/css/popup.css" rel="stylesheet" />
		
		<style type="text/css">
		#stickyList {
			margin:0 0 14px 0;
			padding:0 0 0 ;
		}
		#stickyList li {
			margin:0;
			padding:2px 0 2px 3px;
			list-style-position:inside;
		}
		#stickyList li {
			border-top:1px dashed #cecece;
		}
		#stickyList li:nth-child(1) {
			border-top:0 none;
		}
		div.menu ul {
			margin:0 0 10px 0 ;
			padding:0;
		}
		div.menu li {
			border-bottom:1px dashed #cecece;
			list-style:none;
			padding: 2px 0 4px  ;
		}
		div.menu li span {
			display:none;
		}
		textarea {
			width:500px;
			height:200px;
		}
		</style>
		
	</head>
	
	
	

	<body>
		<h1 class="centre"><a href="http://stickythang.com" target="_blank"><span>StickyThang!</span></a></h1>
		<ul class="menu" dir="rtl">
			<li class="active"><a class="MyStickies"><span>My stickies</span></a></li>
			<li class=""><a class="AllStickies"><span>All stickies</span></a></li>
			<li><a class="LoginForm"><span>Login</span></a></li>
		</ul>
		<div id="LoginForm" class="off unit">
			<form action="http://stickythang.com/phpBB3/ucp.php?mode=login" target="hiddenframe" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p>
					<label>Login with...</label>
					<select>
						<option>StickyThang!</option>
						<option>Google</option>
						<option>FaceBook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<p>
					<label for="username">User:</label><input value="tester" type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input value="password" type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" id="loginButton" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
			</form>
			<iframe id="hiddenframe" name="hiddenframe" frameborder="no" width="1" height="1"></iframe>
		</div>
		<div id="MyStickies" class="on unit">
			<div>
				<h2>My stickies <span id="domainLable"></span></h2>
				<div id="myList" class="menu">
				</div>
				<ul id="stickyList">
					
				</ul>
				<p class="centre">
					<input type="button" id="addNote" value=" Add a new Sticky! " />
				</p>
				<p>
					NB: You'll need to login inorder to share your notes.
				</p>
	
			</div>
		</div>
		<div id="AllStickies" class="off unit">
			<div>
				<h2>All stickies</h2>
				<div id="allList" class="menu">
					
				</div>
	
			</div>
		</div>
		<p class="tac bottom">
			<a target="_blank" href="http://stickythang.com">visit StickyThang!</a>
		</p>
	</body>
		<script>
			var background = chrome.extension.getBackgroundPage().window;
			
			YUI().use('node','yql','json-parse','node-load',function(Y){
				Y.one('#myList').setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>").load("http://stickythang.com/phpBB3/search.php?author=tester")
				var friends = ['tester','patrick'];
				for (var i = 0; i<friends.length ; i++ ){
					//
				}
				
				Y.one('#allList')
					.setContent("<div class=centre><img src='lib/i/8-0.gif' /></div>")
					//.load("http://stickythang.com/phpBB3/search.php?keywords=&terms=all",null,function(){
						// Y.one('#allList').setContent( this.get("id") );
					//})	
				
				Y.one("#addNote").on('click',function(e){
					e.preventDefault();
					chrome.tabs.getSelected(null, function(tab) {
					  chrome.tabs.sendRequest(tab.id, {action: "create-note", tabid: tab.id}, function(response) {
					    console.log(response.data);
					  });
					});			
				});
				Y.all("ul.menu a").on("click",function(e){
					e.preventDefault();
					var target = e.currentTarget;
					
					Y.all("ul.menu li").removeClass("active");
					target.ancestor("li").addClass("active")
					
					Y.all("div.unit").addClass("off")
					Y.one("#"+ target.get("className") ).removeClass("off");
					
				});
				Y.one("#loginButton").on('click',function(e){
					e.preventDefault();
					// Y.one("#loginButton").set('value',typeof background.window)
					// return;
					try {
						var v = background.stickythang.login({
							user:'tester',
							pass:'password'
						})
						Y.one("#loginButton").set('value','v:'+v)
					}catch(e){
						Y.one("#loginButton").set('value','e:'+e.message)
					}
					
				})
				/*
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {action: "get-list", tabid: tab.id}, function(response) {
				    populateList(response);
				  });
				});	
				*/
				function populateList(response){
					var rs = response.results,
						html = "";
		            for (var i = 0; i < rs.length; ++i) {
						html+= '<li><a target="_blank" href="'+ rs[i].url +'">'+ rs[i].note +'</a></li>';
		            }
					Y.one("#stickyList").setContent(html);
					Y.one("#domainLable").setContent(response.domain)
				}	
				//populateList()
				
				Y.YQL('select * from feed where url="http://stickythang.com/phpBB3/feed.php?f=2"', (function(inner) {
					return function(r) {
						//var inner = mod.one('div.inner')
		                if (r && r.query && r.query.results) {
		                    
			                var html = '',
								obj = {},
								str;
		                    
		                    //Walk the list and create the news list
		                    Y.each(r.query.results, function(items) {
		                        Y.each(items, function(v, k) {
		                            if (1) {
		                                if (v.content && v.content.content) {
		                                   v.content = v.content.content.replace(/&quot;/g,'"').replace(/(\r\n|\n|\r)/g,"");
		                                }
										obj = Y.JSON.parse( v.content );
										if (obj.text)
		                                	html += Y.Lang.sub('<li><a href="{url}" target="_blank">{text}</a>', obj);
										//html+= "<li><textarea>"+ obj.className +"\n"+ temp  +"\n"+ (v.content == temp) +"</textarea></li>"
		                            }
		                        });
		                    });
		                    //Set the innerHTML of the module
		                    inner.set('innerHTML', '<ul>' + html + '</ul>');
		                }else{
							inner.set('innerHTML', '<ul>problems :( </ul>');
						}
		            }
		        })(Y.one("#allList")));	
			        
			      
			});
		</script>	
</html>
