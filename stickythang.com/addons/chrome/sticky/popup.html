<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>popup</title>
		<script src="lib/yui/3.4.0/build/yui/yui.js"></script>
		<link href="lib/css/popup.css" rel="stylesheet" />
		
		<style type="text/css">
		#stickyList {
			margin:0 0 14px 0;
			padding:0 0 0 ;
		}
		#stickyList li {
			margin:0;
			padding:2px 0 2px 3px;
			list-style-position:inside;
		}
		#stickyList li {
			border-top:1px dashed #cecece;
		}
		#stickyList li:nth-child(1) {
			border-top:0 none;
		}
		</style>
		
	</head>
	<body>
		<h1 class="centre"><a href="http://stickythang.com"><span>StickyThang!</span></a></h1>
		<ul class="menu">
			<li class="active"><a class="MyStickies"><span>My stickies</span></a></li>
			<li><a class="LoginForm"><span>Login</span></a></li>
		</ul>
		<div id="LoginForm" class="off unit">
			<form action="http://stickythang.com/phpBB3/ucp.php?mode=login" target="hiddenframe" method="post" id="login">
				<input type="hidden" name="redirect" value="index.php"/>
				<p>
					<label>Login with...</label>
					<select>
						<option>StickyThang!</option>
						<option>Google</option>
						<option>FaceBook</option>
						<option>Yahoo</option>
					</select>
				</p>
				<p>
					<label for="username">User:</label><input type="text" tabindex="1" name="username" id="username"/>
				</p>
				<p>
					<label for="password">Password:</label><input type="password" tabindex="2" id="password" name="password"/>
				</p>
				<p class="centre">
					<input type="submit" name="login" tabindex="6"  value="log me in to StickyThang!" />
				</p>
			</form>
			<iframe id="hiddenframe" name="hiddenframe" frameborder="no" width="1" height="1"></iframe>
		</div>
		<div id="MyStickies" class="on unit">
			<div>
				<h2>My stickies for <span id="domainLable"></span></h2>
				<ul id="stickyList">
					
				</ul>
				<div id="outer" style="border:2px solid #cecece">
					<div class="inner"></div>
					
				</div>
				<p class="centre">
					<input type="button" id="addNote" value=" Add a new Sticky! " />
				</p>
				<p>
					NB: You'll need to login inorder to share your notes.
				</p>
	
			</div>
		</div>
		<p class="tac bottom">
			<a target="_blank" href="http://stickythang.com">visit StickyThang!</a>
		</p>
	</body>
		<script>
			YUI().use('node','yql',function(Y){
				Y.one("#addNote").on('click',function(e){
					e.preventDefault();
					chrome.tabs.getSelected(null, function(tab) {
					  chrome.tabs.sendRequest(tab.id, {action: "create-note", tabid: tab.id}, function(response) {
					    console.log(response.data);
					  });
					});			
				});
				Y.all("ul.menu a").on("click",function(e){
					e.preventDefault();
					var target = e.currentTarget;
					
					Y.all("ul.menu li").removeClass("active");
					target.ancestor("li").addClass("active")
					
					Y.all("div.unit").addClass("off")
					Y.one("#"+ target.get("className") ).removeClass("off");
					
				});
				
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {action: "get-list", tabid: tab.id}, function(response) {
				    populateList(response);
				  });
				});	
			
				function populateList(response){
					var rs = response.results,
						html = "";
		            for (var i = 0; i < rs.length; ++i) {
						html+= '<li><a target="_blank" href="'+ rs[i].url +'">'+ rs[i].note +'</a></li>';
		            }
					Y.one("#stickyList").setContent(html);
					Y.one("#domainLable").setContent(response.domain)
				}	
				//populateList()	
					Y.YQL('select * from feed where url="http://stickythang.com/phpBB3/feed.php?f=2"', (function(mod) {
			            return function(r) {
			                if (r && r.query && r.query.results) {
			                    var inner = mod.one('div.inner'),
			                    html = '';
			                    
			                    //Walk the list and create the news list
			                    Y.each(r.query.results, function(items) {
			                        Y.each(items, function(v, k) {
										html+= function(v){
											var t =""
											for (name in v){t+=";"+name}
											return "<li>"+t+"</li>"
										}(v)
			                            if (k < 5) {
			                                if (v.title && v.title.content) {
			                                    v.title = v.title.content;
			                                }
			                                if (v.link && (Y.Lang.isArray(v.link))) {
			                                    v.link = v.link[0];
			                                }
			                                html += Y.Lang.sub('<li><a href="{link}" target="_blank">{title}</a>', v);
			                            }
			                        });
			                    });
			                    //Set the innerHTML of the module
			                    inner.set('innerHTML', '<ul>' + html + '</ul>');
			                }
			            }
			        })(Y.one("#outer")));						
			});
		</script>	
</html>
